{% extends 'base.html' %}

{% block title %}Point of Sale - {{ shop_profile.shop_name }}{% endblock %}

{% block extra_css %}
<style>
    .barcode-input {
        font-size: 1.2rem;
        border: 2px solid var(--primary-color);
    }
    
    .cart-item {
        border-left: 4px solid var(--primary-color);
        background: white;
        margin-bottom: 10px;
        border-radius: 8px;
        transition: transform 0.2s;
    }
    
    .cart-item:hover {
        transform: translateX(5px);
    }
    
    .cart-total {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        border-radius: 10px;
    }
    
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,.15);
    }
    
    .gst-breakdown {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid var(--success-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column - Product Scanner & Search -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">üîç Product Scanner & Search</h5>
            </div>
            <div class="card-body">
                <!-- Barcode Scanner Input -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <label for="barcodeInput" class="form-label">Scan Barcode or Search Product</label>
                        <input type="text" id="barcodeInput" class="form-control barcode-input" 
                               placeholder="Scan barcode or type product name/SKU..." 
                               autocomplete="off">
                        <div class="form-text">
                            üì± Use barcode scanner gun or type manually. Press Enter to add to cart.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Quick Add</label>
                        <button type="button" class="btn btn-outline-primary w-100" onclick="openManualAdd()">
                            ‚ûï Add Manual Item
                        </button>
                    </div>
                </div>
                
                <!-- Product Search Results -->
                <div id="searchResults" class="d-none">
                    <h6>Search Results:</h6>
                    <div id="productList" class="row"></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Products (Quick Add) -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">üî• Quick Add Products</h6>
            </div>
            <div class="card-body">
                <div id="recentProducts" class="row">
                    <div class="col-md-12 text-center text-muted py-3">
                        Products will appear here as you use them
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Shopping Cart -->
    <div class="col-lg-4">
        <div class="card sticky-top">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">üõí Shopping Cart</h5>
            </div>
            <div class="card-body">
                <!-- Customer Name -->
                <div class="mb-3">
                    <label for="customerName" class="form-label">Customer Name (Optional)</label>
                    <input type="text" id="customerName" class="form-control" 
                           placeholder="Walk-in customer">
                </div>
                
                <!-- Cart Items -->
                <div id="cartItems" class="mb-3" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted py-4">
                        Cart is empty<br>
                        <small>Scan products to add them</small>
                    </div>
                </div>
                
                <!-- GST Breakdown -->
                <div class="gst-breakdown mb-3">
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Subtotal (Base):</small><br>
                            <span id="subtotalBase">‚Çπ0.00</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">GST (5%):</small><br>
                            <span id="gstAmount">‚Çπ0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Total -->
                <div class="cart-total p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Total:</h5>
                        <h4 class="mb-0" id="cartTotal">‚Çπ0.00</h4>
                    </div>
                    <div class="text-center mt-2">
                        <small id="itemCount">0 items</small>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" id="checkoutBtn" 
                            onclick="checkout()" disabled>
                        üí≥ Checkout & Print Invoice
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="clearCart()">
                        üóëÔ∏è Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Add Modal -->
<div class="modal fade" id="manualAddModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Manual Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualAddForm">
                    <div class="mb-3">
                        <label class="form-label">Item Description</label>
                        <input type="text" class="form-control" id="manualDescription" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="manualQuantity" value="1" min="0.001" step="0.001" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price (incl. GST)</label>
                            <input type="number" class="form-control" id="manualPrice" min="0.01" step="0.01" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">GST Rate (%)</label>
                            <input type="number" class="form-control" id="manualGstRate" value="5" min="0" max="28" step="0.01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit</label>
                            <input type="text" class="form-control" id="manualUnit" value="pcs">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addManualItem()">Add to Cart</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cart = [];
let currentSearch = '';

// Initialize POS interface
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcodeInput');
    
    // Focus barcode input
    barcodeInput.focus();
    
    // Handle barcode input
    barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchProduct(this.value.trim());
        }
    });
    
    // Handle input changes for live search
    barcodeInput.addEventListener('input', function(e) {
        const query = this.value.trim();
        if (query.length > 2) {
            searchProduct(query);
        } else {
            hideSearchResults();
        }
    });
    
    // Keep focus on barcode input
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.modal') && !e.target.closest('#searchResults')) {
            setTimeout(() => barcodeInput.focus(), 100);
        }
    });
});

// Search for products
function searchProduct(query) {
    if (!query) return;
    
    currentSearch = query;
    
    fetch(`/api/product-lookup/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                hideSearchResults();
            } else if (data.multiple) {
                showSearchResults(data.products);
            } else {
                // Single product found, add to cart
                addToCart(data);
                document.getElementById('barcodeInput').value = '';
                hideSearchResults();
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showError('Search failed. Please try again.');
        });
}

// Show search results
function showSearchResults(products) {
    const resultsDiv = document.getElementById('searchResults');
    const productList = document.getElementById('productList');
    
    productList.innerHTML = '';
    
    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'col-md-6 mb-2';
        productCard.innerHTML = `
            <div class="card product-card" onclick="selectProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">${product.name}</h6>
                    <small class="text-muted">${product.sku}</small>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span class="fw-bold text-success">‚Çπ${product.price}</span>
                        <small class="text-muted">${product.stock !== null ? `Stock: ${product.stock}` : 'No tracking'}</small>
                    </div>
                </div>
            </div>
        `;
        productList.appendChild(productCard);
    });
    
    resultsDiv.classList.remove('d-none');
}

// Hide search results
function hideSearchResults() {
    document.getElementById('searchResults').classList.add('d-none');
}

// Select product from search results
function selectProduct(product) {
    addToCart(product);
    document.getElementById('barcodeInput').value = '';
    hideSearchResults();
}

// Add product to cart
function addToCart(product, quantity = 1) {
    // Check if product already in cart
    const existingIndex = cart.findIndex(item => item.id === product.id);
    
    if (existingIndex >= 0) {
        // Update quantity
        cart[existingIndex].quantity += quantity;
    } else {
        // Add new item
        cart.push({
            id: product.id || null,
            name: product.name,
            description: product.name,
            quantity: quantity,
            unit_price: product.price,
            tax_rate: product.tax_rate || 5,
            unit: product.unit || 'pcs'
        });
    }
    
    updateCartDisplay();
    document.getElementById('barcodeInput').focus();
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center text-muted py-4">
                Cart is empty<br>
                <small>Scan products to add them</small>
            </div>
        `;
        checkoutBtn.disabled = true;
    } else {
        cartItems.innerHTML = '';
        cart.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item p-2 mb-2';
            
            const basePrice = item.unit_price / (1 + item.tax_rate / 100);
            const taxAmount = item.unit_price - basePrice;
            const totalPrice = item.unit_price * item.quantity;
            
            itemDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.description}</h6>
                        <small class="text-muted">‚Çπ${item.unit_price.toFixed(2)} √ó ${item.quantity} ${item.unit}</small>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold">‚Çπ${totalPrice.toFixed(2)}</span>
                        <br>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">√ó</button>
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-6">
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                        <span class="mx-2">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">Base: ‚Çπ${(basePrice * item.quantity).toFixed(2)}</small><br>
                        <small class="text-muted">GST: ‚Çπ${(taxAmount * item.quantity).toFixed(2)}</small>
                    </div>
                </div>
            `;
            cartItems.appendChild(itemDiv);
        });
        checkoutBtn.disabled = false;
    }
    
    updateCartTotals();
}

// Update cart totals
function updateCartTotals() {
    let totalBase = 0;
    let totalGst = 0;
    let totalIncl = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const basePrice = item.unit_price / (1 + item.tax_rate / 100);
        const taxAmount = item.unit_price - basePrice;
        
        totalBase += basePrice * item.quantity;
        totalGst += taxAmount * item.quantity;
        totalIncl += item.unit_price * item.quantity;
        itemCount += item.quantity;
    });
    
    document.getElementById('subtotalBase').textContent = `‚Çπ${totalBase.toFixed(2)}`;
    document.getElementById('gstAmount').textContent = `‚Çπ${totalGst.toFixed(2)}`;
    document.getElementById('cartTotal').textContent = `‚Çπ${totalIncl.toFixed(2)}`;
    document.getElementById('itemCount').textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;
}

// Remove item from cart
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

// Update item quantity
function updateQuantity(index, change) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
        removeFromCart(index);
    } else {
        updateCartDisplay();
    }
}

// Clear cart
function clearCart() {
    if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
        cart = [];
        updateCartDisplay();
        document.getElementById('customerName').value = '';
    }
}

// Open manual add modal
function openManualAdd() {
    const modal = new bootstrap.Modal(document.getElementById('manualAddModal'));
    modal.show();
    setTimeout(() => document.getElementById('manualDescription').focus(), 300);
}

// Add manual item
function addManualItem() {
    const description = document.getElementById('manualDescription').value.trim();
    const quantity = parseFloat(document.getElementById('manualQuantity').value);
    const price = parseFloat(document.getElementById('manualPrice').value);
    const gstRate = parseFloat(document.getElementById('manualGstRate').value);
    const unit = document.getElementById('manualUnit').value.trim();
    
    if (!description || !quantity || !price) {
        showError('Please fill all required fields');
        return;
    }
    
    const manualItem = {
        id: null,
        name: description,
        description: description,
        quantity: quantity,
        unit_price: price,
        tax_rate: gstRate,
        unit: unit
    };
    
    addToCart(manualItem, 0); // Quantity already set
    
    // Close modal and reset form
    bootstrap.Modal.getInstance(document.getElementById('manualAddModal')).hide();
    document.getElementById('manualAddForm').reset();
    document.getElementById('manualQuantity').value = '1';
    document.getElementById('manualGstRate').value = '5';
    document.getElementById('manualUnit').value = 'pcs';
}

// Checkout process
function checkout() {
    if (cart.length === 0) {
        showError('Cart is empty');
        return;
    }
    
    const customerName = document.getElementById('customerName').value.trim();
    
    const checkoutData = {
        items: cart.map(item => ({
            product_id: item.id,
            description: item.description,
            quantity: item.quantity,
            unit_price: item.unit_price,
            tax_rate: item.tax_rate
        })),
        customer_name: customerName
    };
    
    fetch('/api/checkout/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(checkoutData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Invoice ${data.invoice_number} created successfully!`);
            
            // Clear cart
            cart = [];
            updateCartDisplay();
            document.getElementById('customerName').value = '';
            
            // Offer to print invoice
            if (confirm('Invoice created! Would you like to print it now?')) {
                window.open(`/invoice/${data.invoice_id}/print/`, '_blank');
            }
        } else {
            showError(data.error || 'Checkout failed');
        }
    })
    .catch(error => {
        console.error('Checkout error:', error);
        showError('Checkout failed. Please try again.');
    });
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}